<div class="row">
  

  <div class="col-12">
    <h3 class="module-title text-center">{{ moduleName | titlecase }} Registration</h3>

    <div class="stepper mb-4">
      <div *ngFor="let step of steps; let i = index" class="step-wrapper">
        <div class="step">
          <div class="circle" [ngClass]="{'active': currentStep===i+1,'completed': i+1<currentStep}">
            {{ i+1 }}
          </div>
          <div class="step-title">{{ step.title }}</div>
        </div>
        <div *ngIf="i < steps.length - 1" class="line" [ngClass]="{'completed': i+1<currentStep}"></div>
      </div>
    </div>

    <h3 class="text-center my-4">{{ steps[currentStep - 1]?.title }}</h3>

    <form [formGroup]="form">
      <div class="col-3 mx-auto mb-4 text-center">
    <div class="pie-chart-wrapper">
      <svg viewBox="0 0 36 36" class="circular-chart">
        <path class="circle-bg"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <path class="circle"
              [attr.stroke]="steps[currentStep-1].color"
              [attr.stroke-dasharray]="formPercentage + ', 100'"
              d="M18 2.0845
                 a 15.9155 15.9155 0 0 1 0 31.831
                 a 15.9155 15.9155 0 0 1 0 -31.831"/>
        <text x="18" y="20.35" class="percentage">{{ formPercentage }}%</text>
      </svg>
    </div>
  </div>
      <div *ngFor="let field of steps[currentStep - 1].fields" class="mb-3">
        <label>{{ field.label }}</label>

        <input *ngIf="field.type === 'text' || field.type === 'email'" [type]="field.type" class="form-control" [formControlName]="field.name" />
        <input *ngIf="field.type === 'file'" type="file" class="form-control" (change)="onFileChange($event, field.name)" />
        <select *ngIf="field.type === 'select'" class="form-select" [formControlName]="field.name">
          <option [ngValue]="''">Select {{ field.label }}</option>
          <option *ngFor="let opt of field.options || []" [ngValue]="opt.id">{{ opt.name }}</option>
        </select>

        <span class="text-danger" *ngIf="form.get(field.name)?.touched || errorMessages[field.name]">
          <span *ngIf="form.get(field.name)?.hasError('required')">{{ field.label }} is required</span>
          <span *ngIf="form.get(field.name)?.hasError('email')">Please enter a valid email</span>
          <span *ngIf="errorMessages[field.name]">{{ errorMessages[field.name] }}</span>
        </span>
      </div>

      <div *ngIf="currentStep === steps.length && previewData">
        <h4 class="text-center mb-3">Preview Your Details</h4>
        <div class="preview-details">
          <h2>Personal Info</h2>
          <div><strong>Full Name:</strong> {{ previewData.fullname }}</div>
          <div><strong>Email:</strong> {{ previewData.email }}</div>
          <div><strong>Phone:</strong> {{ previewData.phone }}</div>
          <hr>
          <h2>Additional Info</h2>
          <div><strong>Address:</strong> {{ previewData.address }}</div>
          <div><strong>Country:</strong> {{ previewData.country }}</div>
          <div><strong>State:</strong> {{ previewData.state }}</div>
          <div><strong>City:</strong> {{ previewData.city }}</div>
          <div><strong>Pincode:</strong> {{ previewData.pincode }}</div>
          <hr>
          <div *ngIf="previewData.fileUrl">
            <strong>Uploaded Image:</strong><br/>
            <img src="{{previewData.fileUrl}}" alt="Uploaded Image" width="200"/>
          </div>
          
        </div>
      </div>

      <div class="buttons mt-3 text-center">
        <button type="button" class="btn btn-secondary me-2" (click)="prevStep()" [disabled]="currentStep===1">Previous</button>
        
        <button type="button" (click)="nextStep()" class="btn btn-primary" *ngIf="currentStep < steps.length" [disabled]="!isCurrentStepValid()">
  {{ isEditMode && currentStep === 1 ? 'UPDATE' : 'NEXT' }} 
</button>
      </div>
    </form>
  </div>
</div>
